
# Punto extra de Administración de riesgos


Configuramos el ambiente de trabajo
```{r}
# Cargamos librerías necesarias

library(PerformanceAnalytics)
library(zoo)
library(dplyr)

#Cargamos el archivo

data <- read.csv("file1.csv")

#Limpiamos la base

data<- data[,1:2]   #limpiamos simplemente la base

data <- data[!( is.na(data$mexbol_index)),]  #quitamos NA

#agregamos columnas de rendimiento logarítimico

data$rend <- c(NA, log(data$mexbol_index[-1] / data$mexbol_index[-length(data$mexbol_index)]))


# Eliminamos las filas de dias feriados y NA

data <- data[!(data$rend == 0 | is.na(data$rend)),]

#agregamos fechas de predicción

data$fechaPred <- c(data$fechas[-1],"30-Jan-2023")

# Agregamos window size para la funcion rollapply y poder hacer lo mismo que en excel
window_size <- 252

# Definimos cuantil a cierta probabilidad
cuantilProb <- .05
```


## Creamos las columnas para el cálculo de VaR histórico

```{r}

varHist <- rollapply(data=data$rend,width= window_size, FUN=VaR, p = 1-cuantilProb, method = "historical", align = "right")

#agregamos columna VaR histórico

data$varHist <- c(rep(NA, window_size -1), -varHist*100)

```

# Calculamos VaR histórico ponderado 

```{r}
#crear serie de ponderados

nu <- 0.97
ponde <- sort(dgeom(0:251, 1-nu)/(1-nu^252), decreasing = F)


#función para calcular ponderado

varFuncPonde <- function(vectorDatos){
    dataFrameAux <- data.frame(rend=vectorDatos, ponde=ponde) #relacionando ponderaciones
    dataFrameAux <- dataFrameAux[order(dataFrameAux$rend, decreasing = F),] #reordenando por rendimiento
    dataFrameAux$sumaAcumPonde <- cumsum(dataFrameAux$ponde) #prob acumulada
    dataFrameAux<-dataFrameAux[dataFrameAux$sumaAcumPonde>=cuantilProb,] #filtrando para encontrar el cuantil
    varPonderado<-head(dataFrameAux$rend, n=1) #sacando el cuantil

    return(-varPonderado[1])
}

# Calculate VaR histórico ponderado

varHistPonde<- rollapply(data=data$rend,width= window_size, FUN=varFuncPonde, align = "right")

# agrega a la tabla

data$varHistPonde <- c(rep(NA, window_size -1), varHistPonde*100)

#escribe doc

write.csv(data[,c("fechaPred","varHist", "varHistPonde")], file = "my_data.csv")

```


# Calculamos expected shortfall del historical simulation

```{r}
esFunct <- function(vectorDatos){
    varAux <- as.numeric(VaR(vectorDatos, p=1-cuantilProb, method = "historical"))
    esAux <- -vectorDatos[vectorDatos<= varAux]
    return(mean(esAux)*100)
}

expecShortFall <- rollapply(data=data$rend, width=window_size, FUN=esFunct, align="right" )

# agrega a la tabla

data$expecShortFall <- c(rep(NA, window_size -1), expecShortFall)

```



# Calculamos expected shortfall del historical simulation ponderado


```{r}
esFunctPonder <- function(vectorDatos){
    varAux <- varFuncPonde(vectorDatos)
    esAux <- -vectorDatos[vectorDatos<= -varAux]
    return(mean(esAux)*100)
}

expecShortFallPonder <- rollapply(data=data$rend, width=window_size, FUN=esFunctPonder, align="right" )

# agrega a la tabla

data$expecShortFallPonder <- c(rep(NA, window_size -1), expecShortFallPonder)
```


# Calculamos Var y expecShortFall paramétrico


```{r}
#función iterativa
varFuncPar <- function(vectorDatos){
    varAux <- -sd(vectorDatos) * qnorm(cuantilProb)
    return(varAux*100)
}

varHistPar <- rollapply(data=data$rend,width= window_size, FUN=varFuncPar, align = "right")

#agregamos columna VaR histórico paramétrico

data$varHistPar <- c(rep(NA, window_size -1), -varHistPar*100)

#creamos funcion de expect 

esFunctPar <- function(vectorDatos){
    es <- sd(vectorDatos) * dnorm(qnorm(cuantilProb)) / (cuantilProb)
    return(es*100)
}

expecShortFallPar <- rollapply(data=data$rend, width=window_size, FUN=esFunctPar, align="right" )

# agrega a la tabla

data$expecShortFallPar <- c(rep(NA, window_size -1), expecShortFallPar)

```

# Calculamos Var y expecShortFall paramétrico calculando la VOL

```{r}

```
